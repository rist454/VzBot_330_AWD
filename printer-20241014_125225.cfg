###MANTA 8P v2.0 BOARD#

[include mainsail.cfg]
[include config_backup.cfg]
[include timelapse.cfg]
[include stridemax_board.cfg]
[include stridemax_steppers.cfg]
[include KAMP_Settings.cfg]
# [include Exclude_Object.cfg]
[include Start_Stop.cfg]
[include Macro.cfg]
[include Speed.cfg]
[display_status]
[exclude_object]
[firmware_retraction]
#[include K-ShakeTune/*.cfg]

[virtual_sdcard]
path: ~/printer_data/gcodes

[pause_resume]
recover_velocity: 350


# Enable arcs support for Orcaslicer.
[gcode_arcs]
resolution: 0.1

[force_move]
enable_force_move: true


##### VzBoT############
#######################

[printer]
kinematics: corexy
max_velocity: 1000
max_accel: 14400
#max_accel_to_decel: 6500
max_z_velocity: 50
max_z_accel: 300
square_corner_velocity: 15

########################
########################



##StrideMax Dual X
[mcu stridemax_dual_X]
serial: /dev/serial/by-id/usb-Klipper_rp2040_E6612C771F66762B-if00

##StrideMax Dual Y
[mcu stridemax_dual_Y]
serial: /dev/serial/by-id/usb-Klipper_rp2040_E6612C771F398B2B-if00

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_0A0032001851313434373135-if00
restart_method: command

[temperature_sensor Manta_8P_board_MCU]
sensor_type: temperature_mcu

[mcu rpi]
serial: /tmp/klipper_host_mcu


########################
########  Z axis  ######
########################

[stepper_z]
## In Motor 3 position
step_pin: PB8
dir_pin: PB7
enable_pin: !PE0
microsteps: 32
rotation_distance: 4
endstop_pin: probe:z_virtual_endstop              #make sure to set the correct pin here.
#position_endstop: 0.0
position_max: 400
position_min: -5
full_steps_per_rotation: 200
homing_retract_dist: 0.0  #5.0    # beacon needs this to be set to 0
homing_positive_dir: false
homing_speed: 20.0
second_homing_speed: 2.5

#  Motor 3
[tmc2209 stepper_z]
interpolate: true
uart_pin: PB9
#diag_pin: PF2
run_current: 1.1
stealthchop_threshold: 0

[motor_constants SL42STH40-1684A-23]
#TronXY motor
resistance: 1.2
inductance: 0.0022
holding_torque: 0.37
max_current: 1.5
steps_per_revolution: 200


########################
########  Probe  #######
########################

######  Beacon Probe  ######


[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_75A407324E5737374D202020FF112A0C-if00
x_offset: 0 # update with offset from nozzle on your machine
y_offset: 29.3 # update with offset from nozzle on your machine
#contact_max_hotend_temperature: 256 # increase to enable hot contacting. Temperature limit for the hotend when contacting, override this for temps which may damage some surfaces.
mesh_main_direction: x
mesh_runs: 2

home_xy_position: 160, 100 #165, 155 #40 # update with your safe position
home_z_hop: 5
home_z_hop_speed: 30
home_xy_move_speed:1000

home_method: contact #proximity
home_method_when_homed: proximity
home_autocalibrate: unhomed #never

autocal_speed: 3 
autocal_accel: 100
autocal_retract_dist: 2
autocal_retract_speed: 15
autocal_tolerance: 0.008
autocal_sample_count: 2
autocal_max_retries: 5



##############################    bed Level  #####
[bed_mesh]
speed: 600
horizontal_move_z: 15
mesh_min: 10, 35
mesh_max: 320, 300
probe_count: 50, 50
fade_start: 1
fade_end: 10
algorithm: bicubic
bicubic_tension: 0.2
adaptive_margin: 5



[screws_tilt_adjust]
screw1: 5,5
screw1_name: avant_gauche
screw2: 5,270
screw2_name: arriere_gauche
screw3: 325,270
screw3_name: arriere_droit
screw4: 325,5
screw4_name: avant_droit
speed: 400
horizontal_move_z: 5
screw_thread: CCW-M3


[bed_screws]
screw1: 5,5  # front left
screw2: 5,270  # rear left
screw3: 325,270  #rear right
screw4: 325,5  #front right

[axis_twist_compensation]
speed: 150
#   The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.
#horizontal_move_z: 5
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
calibrate_start_x: 20
#   Defines the minimum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the starting
#   calibration position. This parameter must be provided.
calibrate_end_x: 310
#   Defines the maximum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the ending
#   calibration position. This parameter must be provided.
calibrate_y: 155
#   Defines the Y coordinate of the calibration
#   This should be the Y coordinate that positions the nozzle during the
#   calibration process. This parameter must be provided and is recommended to
#   be near the center of the bed



[extruder]
step_pin: PG9
dir_pin: !PD7
enable_pin: !PG11
microsteps: 16
gear_ratio: 60:10 #(For 10th motor gear)
rotation_distance: 34.9    #7.4835 #7.5749
nozzle_diameter: 0.4
filament_diameter: 1.75
heater_pin: PA0 # HE0
sensor_pin: PC5 # T0
sensor_type: PT1000 #ATC Semitec 104NT-4-R025H42G #Generic 3950
pullup_resistor: 4700
max_extrude_only_distance: 1000.0
max_extrude_only_velocity: 100
max_extrude_cross_section: 500
min_temp: 0
max_temp: 500



#   Motor 6
[tmc2209 extruder]
uart_pin: PG10
interpolate: false
run_current: 0.7
sense_resistor: 0.110

[output_pin Light]
pin: PA3


#####   Filament Sensor  ######

[filament_switch_sensor switch_sensor]
switch_pin: ^PF0
pause_on_runout: False
event_delay: 1.5
pause_delay: 0.5
runout_gcode:
   PAUSE # [pause_resume] is required in printer.cfg
   M117 Filament switch runout
insert_gcode:
   M117 Filament switch inserted

[filament_motion_sensor encoder_sensor]
switch_pin: ^PC15
detection_length: 12 # accuracy of motion sensor 2.88mm
extruder: extruder
pause_on_runout: False
event_delay: 1.5
pause_delay: 0.5

runout_gcode:
   PAUSE # [pause_resume] is required in printer.cfg
   M117 Filament encoder runout
insert_gcode:
   M117 Filament encoder inserted


#######################
#######################

[heater_bed]
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PB1
min_temp: 0
max_temp: 130


#######################
### FANS ##############
#######################

[fan]
##	Print Cooling Fan - PF6
pin: PF6
# max_power: 1
# cycle_time: 0.002
# hardware_pwm: false
# shutdown_speed: 0

[heater_fan hotend_fan]
pin: PF8
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[temperature_fan Board_fan]
# pin: rpi:gpio79
pin: rpi:gpio26
kick_start_time: 0.8
off_below: 0.2
max_power: 1.0
sensor_type: temperature_host
control: pid
min_temp: 10
max_temp: 100
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0
max_speed: 0.8
target_temp: 45



[idle_timeout]
timeout: 1800
gcode =
  {% if printer.pause_resume.is_paused %}
    M104 S0
  {% else %}
    TURN_OFF_HEATERS
    #M84
  {% endif %}


  #########################################################################################################
  ##################### Resonance Tester  #################################################################
  #########################################################################################################


  ######  Beacon  #####

[resonance_tester]
accel_chip: beacon
probe_points: 170, 170, 20

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
number_of_results_to_keep: 3
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
keep_raw_csv: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.033652, 0.033673, 0.034317, 0.040293, 0.035650, 0.038019, 0.034485, 0.030314, 0.028011, 0.021372, 0.022448, 0.019892, 0.017185, 0.010206
#*# 	0.038483, 0.040785, 0.040587, 0.041545, 0.041313, 0.040198, 0.043388, 0.040238, 0.036590, 0.031714, 0.029654, 0.022354, 0.018057, 0.012564
#*# 	0.042504, 0.043552, 0.044429, 0.043840, 0.044304, 0.041848, 0.041946, 0.043705, 0.038519, 0.033315, 0.031716, 0.023478, 0.020880, 0.016260
#*# 	0.050081, 0.053053, 0.050748, 0.050284, 0.049064, 0.047627, 0.048605, 0.047392, 0.048308, 0.045309, 0.042103, 0.032895, 0.029379, 0.026331
#*# 	0.055909, 0.058695, 0.060325, 0.058348, 0.058329, 0.054872, 0.055843, 0.057776, 0.058015, 0.054729, 0.051767, 0.042602, 0.041789, 0.035950
#*# 	0.066704, 0.068129, 0.067614, 0.070082, 0.069382, 0.067651, 0.069433, 0.068856, 0.068537, 0.067058, 0.064810, 0.057687, 0.053090, 0.052786
#*# 	0.073379, 0.075359, 0.080033, 0.081013, 0.084059, 0.081720, 0.081375, 0.084264, 0.081101, 0.077931, 0.077372, 0.073088, 0.073079, 0.066560
#*# 	0.085963, 0.086787, 0.088743, 0.095065, 0.092954, 0.094390, 0.095862, 0.092710, 0.089978, 0.088591, 0.088267, 0.084155, 0.083086, 0.079090
#*# x_count = 14
#*# y_count = 8
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 132.5
#*# max_x = 192.5
#*# min_y = 139.498
#*# max_y = 170.502
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 97.6
#*# shaper_type_y = ei
#*# shaper_freq_y = 88.8
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 20.605
#*# pid_ki = 1.543
#*# pid_kd = 68.770
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 66.730
#*# pid_ki = 2.986
#*# pid_kd = 372.852
#*#
#*# [beacon model default]
#*# model_coef = 1.748032773600288,
#*# 	  2.076602130461356,
#*# 	  0.5936126345704246,
#*# 	  0.17684889130180081,
#*# 	  0.3985688407862374,
#*# 	  0.1294305441247659,
#*# 	  -0.3842818348705649,
#*# 	  0.0034837521303284374,
#*# 	  0.24438950037367255,
#*# 	  0.017127152488782375
#*# model_domain = 1.8864725561088747e-07,1.9317915710314958e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 22.301256
#*# model_offset = 0.00000
#*#
#*# [axis_twist_compensation]
#*# z_compensations = 0.040313, 0.020579, -0.060892
#*# compensation_start_x = 20.0
#*# compensation_end_x = 310.0
